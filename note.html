<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Futuro Fortissimo â€” Note</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/index_files/ff.webp" type="image/webp">
    <link rel="apple-touch-icon" href="/index_files/ff.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Mono:wght@600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { --ff-blue:#4a90e2; --ff-red:#d0021b; --ff-yellow:#f5a623; --ff-green:#2ecc71; --ff-black:#0a0a0a; --ff-grid:rgba(0,0,0,0.03); }
        body { font-family:'Inter',sans-serif; background-color:#fdfdfd; color:var(--ff-black); min-height:100vh; line-height:1.6; position:relative; }
        body::before { content:''; position:fixed; inset:0; background-image:linear-gradient(var(--ff-grid) 1px,transparent 1px),linear-gradient(90deg,var(--ff-grid) 1px,transparent 1px); background-size:32px 32px; pointer-events:none; z-index:-1; }
        h1,h2,h3,h4,h5,h6 { font-family:'IBM Plex Mono',monospace; letter-spacing:0.03em; text-transform:uppercase; }
        .brutal-card { border:4px solid var(--ff-black); background:#fff; box-shadow:6px 6px 0 var(--ff-black); padding:24px; }
        .accent-bar { position:relative; }
        .accent-bar::before { content:''; position:absolute; top:-4px; left:-4px; right:-4px; height:10px; background:var(--ff-blue); }
        .accent-red::before { background:var(--ff-red); }
        .accent-yellow::before { background:var(--ff-yellow); }
        .accent-green::before { background:var(--ff-green); }
        .ff-eyebrow { font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.24em; text-transform:uppercase; font-weight:700; }
        .ff-body { font-size:1rem; line-height:1.65; }
        .ff-body-sm { font-size:0.9375rem; line-height:1.6; }
        .no-round,.no-round * { border-radius:0!important; }
        a:focus-visible { outline:3px solid var(--ff-black); outline-offset:2px; }
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }

        .ff-input {
            border:3px solid var(--ff-black);
            border-radius:0;
            padding:10px 14px;
            font-family:'Inter',sans-serif;
            font-size:1rem;
            outline:none;
            transition:box-shadow 0.15s;
        }
        .ff-input:focus {
            box-shadow:4px 4px 0 var(--ff-black);
        }
        .tag-pill {
            border:2px solid var(--ff-black);
            border-radius:0;
            padding:4px 10px;
            cursor:pointer;
            font-size:1.1rem;
            background:#fff;
            transition:background 0.15s, transform 0.1s;
            user-select:none;
        }
        .tag-pill:hover {
            background:#f0f0f0;
            transform:translateY(-1px);
        }
        .tag-pill.selected {
            background:var(--ff-yellow);
            box-shadow:3px 3px 0 var(--ff-black);
        }
        .note-card {
            transition:transform 0.15s, box-shadow 0.15s;
        }
        .note-card:hover {
            transform:translate(-2px,-2px);
            box-shadow:8px 8px 0 var(--ff-black);
        }
    </style>
</head>
<body class="no-round">

<header class="bg-white" style="border-bottom:4px solid var(--ff-black)">
    <div class="max-w-5xl mx-auto px-6 py-5 flex items-center justify-between gap-4">
        <div>
            <div class="ff-eyebrow text-gray-500">Futuro Fortissimo â€” Taccuino</div>
            <h1 class="text-2xl font-bold tracking-tight mt-1" style="font-size:clamp(1.4rem,1.1rem+1vw,2rem)">NOTE</h1>
        </div>
        <nav class="flex gap-4 flex-shrink-0">
            <a class="ff-eyebrow text-gray-600 hover:text-black hover:underline" href="/index.html">Home</a>
            <a class="ff-eyebrow text-gray-600 hover:text-black hover:underline" href="/book/">Libro</a>
            <a class="ff-eyebrow text-gray-600 hover:text-black hover:underline" href="/themes.html">Temi</a>
            <a class="ff-eyebrow text-gray-600 hover:text-black hover:underline" href="/note.html">Note</a>
        </nav>
    </div>
</header>

<main class="max-w-5xl mx-auto px-6 py-8">
    <!-- Search / Filter bar -->
    <div class="brutal-card accent-bar mb-8">
        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
            <div class="flex gap-3 flex-1 w-full">
                <input type="text" id="search-input" class="ff-input flex-1" placeholder="Cerca una nota...">
                <button id="refresh-btn" class="tag-pill font-bold" title="Reset">&#x21bb;</button>
                <button id="lang-btn" class="tag-pill ff-eyebrow" style="font-size:0.7rem;padding:6px 12px;">EN</button>
            </div>
            <div class="flex flex-wrap gap-2" id="tag-filters">
                <!-- Tag pills inserted dynamically -->
            </div>
        </div>
    </div>

    <!-- Count -->
    <div class="ff-eyebrow text-gray-500 mb-4" id="count-display">Caricamento...</div>

    <!-- Notes Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="notes-grid">
        <!-- Cards inserted dynamically -->
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let currentLanguage = 'it';
    const searchInput = document.getElementById('search-input');
    const refreshBtn = document.getElementById('refresh-btn');
    const langBtn = document.getElementById('lang-btn');
    const tagFiltersContainer = document.getElementById('tag-filters');
    const notesGrid = document.getElementById('notes-grid');
    const countDisplay = document.getElementById('count-display');

    const TAG_EMOJIS = ['ðŸ’»','ðŸ§ ','â¤ï¸','ðŸ‘¥','ðŸŽ¨','ðŸƒ','ðŸ’Š','ðŸ’¸','âš½','ðŸ½','ðŸŽ™ï¸','ðŸ“š','ðŸ¥½','ðŸš•'];
    let allNotes = [];
    let selectedTags = new Set();

    // Build tag filter pills
    TAG_EMOJIS.forEach(emoji => {
        const pill = document.createElement('button');
        pill.className = 'tag-pill';
        pill.textContent = emoji;
        pill.setAttribute('data-tag', emoji);
        pill.addEventListener('click', () => {
            if (selectedTags.has(emoji)) {
                selectedTags.delete(emoji);
                pill.classList.remove('selected');
            } else {
                selectedTags.add(emoji);
                pill.classList.add('selected');
            }
            applyFilters();
        });
        tagFiltersContainer.appendChild(pill);
    });

    // Italian stop words for search filtering
    const stopWords = new Set([
        'perchÃ¨','perchÃ©','quando','e','ma','se','come','con','su','per','tra','fra',
        'nel','nello','nella','nei','nelle','al','allo','alla','ai','agli','alle',
        'dal','dallo','dalla','dai','dagli','dalle','del','dello','della','dei','degli',
        'delle','sul','sullo','sulla','sui','sugli','sulle','un','uno','una','gli','le',
        'di','da','in','a','che','chi','cosa','quale','quanto','quanta','quanti','quante',
        'dove','anche','solo','qui','lÃ¬','lÃ ','dunque','quindi','perciÃ²','ancora','giÃ ',
        'mai','sempre','poi','prima','dopo','sopra','sotto','contro','molto','poco',
        'troppo','piÃ¹','meno','bene','male','meglio','peggio','quasi','circa','appena',
        'tanto','cosÃ¬','pure','neanche','nemmeno','sia'
    ]);

    function shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }

    function applyFilters() {
        const searchText = searchInput.value.toLowerCase().trim();
        const searchWords = searchText.split(/\s+/).filter(w => w && !stopWords.has(w));
        let filtered = allNotes;

        if (searchWords.length > 0) {
            filtered = filtered.filter(note => {
                const combined = `${note.tags.join(' ')} ${note.title} ${note.description} ${note.hashtags || ''}`.toLowerCase();
                return searchWords.every(word => combined.includes(word));
            });
        }

        if (selectedTags.size > 0) {
            filtered = filtered.filter(note => {
                return [...selectedTags].every(tag => note.tags.includes(tag));
            });
        }

        const total = filtered.length;
        const shuffled = shuffle(filtered);
        const display = shuffled.slice(0, 40);

        countDisplay.textContent = currentLanguage === 'it'
            ? `${display.length} note su ${total}`
            : `${display.length} notes of ${total}`;

        renderNotes(display);
    }

    function renderNotes(notes) {
        notesGrid.innerHTML = '';
        if (notes.length === 0) {
            notesGrid.innerHTML = '<div class="col-span-full text-center py-12"><p class="ff-body text-gray-500">' +
                (currentLanguage === 'it' ? 'Nessuna nota trovata.' : 'No notes found.') + '</p></div>';
            return;
        }

        const accentClasses = ['accent-bar', 'accent-bar accent-red', 'accent-bar accent-yellow', 'accent-bar accent-green'];

        notes.forEach((note, i) => {
            const card = document.createElement('div');
            card.className = `brutal-card note-card ${accentClasses[i % accentClasses.length]}`;

            const tagsSpan = document.createElement('div');
            tagsSpan.className = 'text-lg mb-2';
            tagsSpan.textContent = note.tags.join(' ');

            const title = document.createElement('h3');
            title.className = 'text-base font-bold mb-2 leading-snug';
            title.textContent = note.title;

            const desc = document.createElement('p');
            desc.className = 'ff-body-sm text-gray-600 mb-4';
            desc.textContent = note.description;

            const link = document.createElement('a');
            link.className = 'ff-eyebrow hover:underline';
            link.style.color = 'var(--ff-blue)';
            link.href = note.url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = currentLanguage === 'it' ? 'APRI \u2192' : 'OPEN \u2192';

            card.appendChild(tagsSpan);
            card.appendChild(title);
            card.appendChild(desc);
            card.appendChild(link);
            notesGrid.appendChild(card);
        });
    }

    async function loadNotes() {
        const file = currentLanguage === 'it' ? '/notes.json' : '/notes_en.json';
        try {
            const res = await fetch(file);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            allNotes = data.notes || data;
            applyFilters();
        } catch (err) {
            console.error('Error loading notes:', err);
            notesGrid.innerHTML = '<div class="col-span-full text-center py-12"><p class="ff-body text-gray-500">Errore nel caricamento.</p></div>';
        }
    }

    searchInput.addEventListener('input', applyFilters);
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') applyFilters(); });

    refreshBtn.addEventListener('click', () => {
        searchInput.value = '';
        selectedTags.clear();
        tagFiltersContainer.querySelectorAll('.tag-pill').forEach(p => p.classList.remove('selected'));
        applyFilters();
    });

    langBtn.addEventListener('click', () => {
        currentLanguage = currentLanguage === 'it' ? 'en' : 'it';
        langBtn.textContent = currentLanguage === 'it' ? 'EN' : 'IT';
        searchInput.placeholder = currentLanguage === 'it' ? 'Cerca una nota...' : 'Search notes...';
        loadNotes();
    });

    loadNotes();
});
</script>
</body>
</html>
